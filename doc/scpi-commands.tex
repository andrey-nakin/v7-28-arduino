\documentclass[10pt, a4paper, twocolumn]{article}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{hyperref}
\usepackage[]{graphicx}

\title{Прошивка для Arduino Mega 2560, подключённого к вольтметру В7-28}

\newcommand{\SCPI}{\mbox{SCPI}}
\newcommand{\V}{\mbox{В7-28}}
\newcommand{\Arduino}{Arduino Mega}

\newcommand{\CMD}[1]{{\tt #1}}
\newcommand{\PARAM}[1]{"<{\it #1}>"}
\newcommand{\CMDSTUB}[1]{{\tt #1}*}

\newcommand{\SUBSYSTEMSECTION}[1]{\subsection{Подсистема \CMD{#1}}}
\newcommand{\CMDSECTION}[1]{\subsubsection*{\CMD{#1}}}

\begin{document}

\maketitle

\section{Введение}

Данный документ описывает прошивку для микроконтроллера \Arduino{} или совместимого с ним, которая реализует ограниченный набор \SCPI{} команд цифрового мультиметра. Функции мультиметра выполняет цифровой вольтметр \V.

\subsection{Краткое описание вольтметра}

\V{} --- многофункциональный вольтметр среднего класса точности, выпускается с 1970-х годов по сию пору. Его характеристики уступают современным мультиметрам, таким как Agilent \mbox{34401A}, но для многих применений они достаточны, к тому же ещё много экземпляров \V{} находятся в строю.

\V{} имеет возможность дистанционного управления и снятия показаний, что позволяет его использовать в автоматизированных измерительных установках. Но для управления требуется физически задавать и считывать логические сигналы на разъёмах вольтметра. Разумеется, в самом вольтметре не реализован какой-либо язык управления. В настоящее время для работы с ним как правило используются аппаратно-программные решения на базе КАМАК.

\subsection{Необходимость данной работы}

Для простоты использования какого-либо устройства в современных измерительных установках требуется наличие у него современных стандартных аппаратного и программного интерфейсов.

В качестве аппаратного интерфейса практически безальтернативно выступает USB, которым сейчас оборудуются даже мобильные телефоны и планшеты, не говоря уже о ноутбуках и стационарных компьютерах.

В качестве программного интерфейса мы видим наиболее подходящей систему команд \SCPI, которая разработа достаточно давно, хорошо стандартизирована и документирована, и используется во многих современных измерительных устройствах.

Таким образом, необходимо <<остастить>> вольтметр \V{} интерфейсом USB и возможностью принимать команды на языке \SCPI. Тогда он с минимальными усилиями (а в идеале~--- сразу и без усилий) сможет войти в состав измерительных установок, где программная часть написана при помощи стандартных средств типа LabVIEW, и используются обычные современные персональные компьютеры без каких-либо плат расширения и модулей КАМАК.

\subsection{Почему Arduino}

\Arduino{} представляет собой плату микроконтроллера с установленным микропроцессором, программируемой памятью, множеством цифровых портов ввода-вывода и USB-разъёмом. Из всего семейства микроконтроллеров Arduino только Mega обладает числом портов достаточным для полноценного управления \V. Микроконтроллер подключается к компьютеру при помощи USB, а к вольтметру при помощи шлейфа, который легко изготовить самостоятельно.  В память микроконтроллера прошита программа, принимающая команды от компьютера на языке \SCPI{} и переводящая их в управляющие сигналы для \V.

\Arduino{} является готовым устройством, что удобно для конечного пользователя, не имеющего возможности самостоятельно распаивать платы микроконтроллеров. Он широко распространён, его легко приобрести, по нему доступна обширная документация. Наряду с <<оригинальным>> микроконтроллером, выходящим под торговой маркой Arduino, доступно множество более дешёвых аналогов, которые полностью совместимы с \Arduino{} при в несколько раз меньшей цене.

\section{Подключение {\Arduino} к \V}

\subsection{Распайка разъёмов}

Управление и считывание данных с {\V} осуществляется по двум разъёмам на задней панели вольтметра: ЦПУ и ДУ.

Распайка разъёмов ЦПУ и ДУ представлена в таблицах~\ref{tab_cpu_wires} (стр.~\pageref{tab_cpu_wires}) и~\ref{tab_rc_wires} (стр.~\pageref{tab_rc_wires}).

Расположение контактов на разъёмах ЦПУ и ДУ изображено на рисунках~\ref{pic-cpu-jack} (стр.~\pageref{pic-cpu-jack}) и~\ref{pic-rc-jack} (стр.~\pageref{pic-rc-jack}).

\begin{table*}
\begin{center}
\caption{Распайка разъёма ЦПУ (56 контактов)}
\begin{tabular}{cccc}
\hline \hline
Контакт & Контакт & Контакт & Контакт \\
Arduino & разъёма ЦПУ & Arduino & разъёма ЦПУ \\
\hline
GND & 1 & - & А \\
- & 2 & - & Б \\
- & 3 & - & В \\
- & 4 & - & Г \\
+5V & 5 & 19 & Д \\
2 & 6 & 22 & Е \\
23 & 7 & 24 & Ж \\
- & 8 & - & <<З>> \\
- & 9 & - & И \\
- & 10 & 25 & К \\
26 & 11 & 27 & Л \\
28 & 12 & - & М \\
20 & 13 & 21 & Н \\
29 & 14 & 30 & <<О>> \\
31 & 15 & 32 & П \\
- & 16 & 3 & Р \\
A0 & 17 & A1 & С \\
A2 & 18 & 33 & Т \\
34 & 19 & 35 & У \\
36 & 20 & 37 & Ф \\
38 & 21 & 39 & Х \\
40 & 22 & 41 & Ц \\
42 & 23 & 43 & Ч \\
44 & 24 & 45 & Ш \\
46 & 25 & 47 & Ы \\
48 & 26 & 49 & Э \\
50 & 27 & 51 & Ю \\
52 & 28 & 53 & Я \\
\hline \hline
\end{tabular}
\label{tab_cpu_wires}
\end{center}
\end{table*}

\begin{figure*}
\begin{center}
\includegraphics[width=\textwidth, clip, viewport=0 800 360 830]{cpu-jack}
\end{center}
\caption{Расположение контактов на разъёме ЦПУ}
\label{pic-cpu-jack}
\end{figure*}

\begin{table*}
\begin{center}
\caption{Распайка разъёма ДУ (22 контакта)}
\begin{tabular}{cccc}
\hline \hline
Контакт & Контакт & Контакт & Контакт \\
Arduino & разъёма ДУ & Arduino & разъёма ДУ \\
\hline
GND & 1 & 4 & А \\
5 & 2 & 6 & Б \\
7 & 3 & 8 & В \\
9 & 4 & 10 & Г \\
11 & 5 & 12 & Д \\
13 & 6 & 14 & Е \\
15 & 7 & 16 & Ж \\
17 & 8 & 0 & <<З>> \\
1 & 9 & - & И \\
- & 10 & - & К \\
- & 11 & +5V & Л \\
\hline \hline
\end{tabular}
\label{tab_rc_wires}
\end{center}
\end{table*}

\begin{figure*}
\begin{center}
\includegraphics[width=\textwidth, clip, viewport=0 800 360 830]{rc-jack}
\end{center}
\caption{Расположение контактов на разъёме ДУ}
\label{pic-rc-jack}
\end{figure*}

\section{Список команд}

В данном разделе приведены все \SCPI{} команды, реализованные в прошивке. Порядок изложения --- алфавитный с разбивкой на подсистемы. Команда может сопровождаться комментарием, описывающим особенности реализации.

Данная прошивка реализует ограниченное множество \SCPI{} команд мультиметра Hewlett-Packard (ныне~--- Agilent) \mbox{34401A}. Микроконтроллер подключается к ПЭВМ посредством USB соединения и эмулирует последовательный порт. Таким образом, связка <<микроконтроллер --- вольтметр>> со стороны ПЭВМ выглядит как мультиметр \mbox{34401A}, и может использоваться в измерительных программах без модификации программного кода, хотя и с учётом ограничений \V (по скорости работы, точности и пр.).

Команды, отсутствующие в данном списке, не реализованы. При получении нереализованной или неизвестной команды генерируется ошибка \CMD{-113} <<Undefined header>>.

\SUBSYSTEMSECTION{IEEE-488}

\CMDSECTION{*CLS}
\CMDSECTION{*ESE}
\CMDSECTION{*ESE?}
\CMDSECTION{*ESR?}
\CMDSECTION{*IDN?}

Возвращается строка, имитирующая мультиметр Hewlett-Packard 34401A.

\CMDSECTION{*OPC}
\CMDSECTION{*OPC?}
\CMDSECTION{*RST}
\CMDSECTION{*SRE}
\CMDSECTION{*SRE?}
\CMDSECTION{*STB?}
\CMDSECTION{*TST?}

Из-за отсутствия технической возможности фактически тестирование не производится.

\CMDSECTION{*WAI}

\SUBSYSTEMSECTION{CONFigure}

В командах \CMD{CONFigure:<function>} параметр \PARAM{resolution} не используется, поскольку \V{} не имеет возможности управления точностью измерений.

\CMDSECTION{CONFigure:RESistance}
\CMDSECTION{CONFigure:VOLTage:AC}
\CMDSECTION{CONFigure:VOLTage:DC}
\CMDSECTION{CONFigure:VOLTage:DC:RATio}

\SUBSYSTEMSECTION{INPut}

\CMDSECTION{INPut:IMPedance:AUTO}
\CMDSECTION{INPut:IMPedance:AUTO?}

Команда отрабатывает, состояние сохраняется в оперативной памяти, но реально изменения входного сопротивления \V{} не происходит.

\SUBSYSTEMSECTION{MEASure}

\CMDSECTION{MEASure:RESistance?}
\CMDSECTION{MEASure:VOLTage:AC?}
\CMDSECTION{MEASure:VOLTage:DC?}
\CMDSECTION{MEASure:VOLTage:DC:RATio?}

\SUBSYSTEMSECTION{ROUTe}

\CMDSECTION{ROUTe:TERMinals?}

Всегда возвращает \CMD{FRON}.

\SUBSYSTEMSECTION{SYSTem}

\CMDSECTION{SYSTem:ERRor}
\CMDSECTION{SYSTem:BEEPer}

Команда принимается, но зуммер не звучит в связи с отсутствием соответствующего устройства на плате микроконтроллера.

\CMDSECTION{SYSTem:BEEPer:STATe?}
\CMDSECTION{SYSTem:LOCal}
\CMDSECTION{SYSTem:REMote}

Команда \CMD{SYSTem:REMote} всегда действует аналогично команде \CMD{SYSTem:RWLock}, то есть управление вольтметром с передней панели запрещено в remote-режиме.

\CMDSECTION{SYSTem:RWLock}
\CMDSECTION{SYSTem:VERSion?}

\end{document}
