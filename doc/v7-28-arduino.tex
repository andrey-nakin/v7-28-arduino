\documentclass[12pt, a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{hyperref}
\usepackage[]{graphicx}

\input title.tex

\newcommand{\SCPI}{\mbox{SCPI}}
\newcommand{\V}{\mbox{В7-28}}
\newcommand{\Arduino}{Arduino Mega}

\newcommand{\CMD}[1]{{\tt #1}}
\newcommand{\PARAM}[1]{<<{\it #1}>>}
\newcommand{\RESPONSE}[1]{<<{\tt #1}>>}
\newcommand{\CMDSTUB}[1]{{\tt #1}*}

\newcommand{\SUBSYSTEMSECTION}[1]{\subsubsection{Подсистема \CMD{#1}}}
\newcommand{\CMDSECTION}[1]{\CMD{#1}  }

\begin{document}

\maketitle

\section{Введение}

Данный документ описывает прошивку для микроконтроллера \Arduino{} или совместимого с ним, которая реализует ограниченный набор \SCPI{} команд цифрового мультиметра. Функции мультиметра выполняет цифровой вольтметр \V.

\subsection{Краткое описание вольтметра}

\V{} --- многофункциональный вольтметр среднего класса точности, выпускается с 1970-х годов по сию пору. Его характеристики уступают современным мультиметрам, таким как Agilent \mbox{34401A}, но для многих применений они достаточны, к тому же ещё много экземпляров \V{} находятся в строю.

\V{} имеет возможность дистанционного управления и снятия показаний, что позволяет его использовать в автоматизированных измерительных установках. Но для управления требуется физически задавать и считывать логические сигналы на разъёмах вольтметра. Разумеется, в самом вольтметре не реализован какой-либо язык управления. В настоящее время для работы с ним как правило используются аппаратно-программные решения на базе КАМАК.

Использование данной прошивки позволяет с минимальными усилиями использовать \V{} (и совместимые с ним по интерфейсу) в современных автоматизированных измерительных установках.

\subsection{Необходимость данной работы}

Для простоты использования какого-либо устройства в современных измерительных установках требуется наличие у него современных стандартных аппаратного и программного интерфейсов.

В качестве аппаратного интерфейса практически безальтернативно выступает USB, которым сейчас оборудуются даже мобильные телефоны и планшеты, не говоря уже о ноутбуках и стационарных компьютерах.

В качестве программного интерфейса мы видим наиболее подходящей систему команд \SCPI, которая разработана достаточно давно, хорошо стандартизирована и документирована, и используется во многих современных измерительных устройствах.

Таким образом, необходимо <<остастить>> вольтметр \V{} интерфейсом USB и возможностью принимать команды на языке \SCPI. Тогда он с минимальными усилиями (а в идеале~--- сразу и без усилий) сможет войти в состав измерительных установок, где программная часть написана при помощи стандартных средств типа LabVIEW, и используются обычные современные персональные компьютеры без каких-либо плат расширения и модулей КАМАК.

\subsection{Почему Arduino}

\Arduino{} представляет собой плату микроконтроллера с установленным микропроцессором, программируемой памятью, множеством цифровых портов ввода-вывода и USB-разъёмом. Из всего семейства микроконтроллеров Arduino только Mega обладает числом портов достаточным для полноценного управления \V. Микроконтроллер подключается к компьютеру при помощи USB, а к вольтметру при помощи шлейфа, который легко изготовить самостоятельно.  В память микроконтроллера прошита программа, принимающая команды от компьютера на языке \SCPI{} и переводящая их в управляющие сигналы для \V.

\Arduino{} является готовым устройством, что удобно для конечного пользователя, не имеющего возможности самостоятельно проектировать и производить платы микроконтроллеров. Он широко распространён, его легко приобрести, по нему доступна обширная документация. Наряду с <<оригинальным>> микроконтроллером, выходящим под торговой маркой Arduino, доступно множество более дешёвых аналогов, которые полностью совместимы с \Arduino{} при в несколько раз меньшей цене.

Таким образом объём работ, необходимых для <<модернизации>> \V{}, сводится к минимуму:

\begin{itemize}
\item приобрести \Arduino{};
\item залить в \Arduino{} прошивку с микропрограммой при помощи бесплатной утилиты;
\item подключить \Arduino{} к разъёмам \V{} посредством шлейфа;
\item при необходимости подключить к \Arduino{} звукоизлучатель для воспроизведения зуммера и/или внешний источник сигналов для аппаратного триггера. Данный пункт можно опустить.
\end{itemize}

Шлейф можно распаять на монтажной плате, совместимой с \Arduino{} по расположению контактов. Также можно приобрести шлейфы с <<нанизанными>> штырьковыми соединителями, в этом случае монтажная плата не нужна, а распаивать нужно только шлейф на разъёмах \V{}. В любом случае объём пайки небольшой и не требует высокой квалификации.

\section{Общее описание прошивки и реализуемого с её помощью мультиметра}

\subsection{Зуммер}
\label{sec_zummer}

Типичный SCPI-мультиметр способен издавать звук зуммера при возникновении нештатной ситуации, обнаружении ошибки или по команде от ПК.

Данная версия прошивки реализует зуммер на пине №~13. Для проигрывания необходимо подключить к {\Arduino} звукоизлучатель, например пьезоэлектрический.

Зуммер проигрывается при обнаружении ошибки в SCPI-командах, а также по команде {\tt SYSTem:BEEPer}.

\subsection{Внешний аппаратный триггер}

Данная версия прошивки позволяет использование внешнего аппаратного триггера для начала измерения. Внешний триггер включается командой {\tt TRIGger:SOURce EXTernal}.

Внешний триггер подключается к пину №~18, что соответствует сигналу прерывания №~5. Сигналом для начала измерений является падение уровня сигнала с логической единицы до логического нуля. 

В случае, когда мультиметр не настроен на использование внешнего триггера, его сигналы игнорируются.

\subsection{Управление точностью измерений}
\label{sec_precision}

\V{} не имеет возможности управлять точностью измерений (если не считать возможности включения фильтрации с передней панели). Поэтому все SCPI команды, управляющие точностью, на самом деле ничего не меняют в работе вольтметра. Измерения всегда производятся к максимальной точностью, равной 5 десятичным знакам в мантиссе.

Команды, устанавливающие параметр \PARAM{resolution} (например, \CMD{CONF:VOLT}) проверяют правильность переданного аргумента, но далее его значение игнорируется.

Команды, возвращающие параметр \PARAM{resolution} (например, \CMD{CONF?}) всегда возвращают значение, равное текущему диапазону измерений, умноженному на $10^{-5}$. Например, если текущий диапазон измерения равен \CMD{10}, то команда \CMD{CONF?} вернёт \RESPONSE{+1.0E-04} в качестве \PARAM{resolution}.

Команды, устанавливающие параметр \PARAM{NPLCycles} (например, \CMD{SENS:VOLT:NPLC}) не делают ничего, аргумент  проверяется на допустимость значений, но его значение игнорируется.

Команды, возвращающие параметр \PARAM{NPLCycles} (например, \CMD{SENS:VOLT:NPLC?}) всегда возвращают значение \RESPONSE{100}, что соответствует времени измерения равному 4~секундам.

На самом деле продолжительность измерения зависит от многих факторов и варьируется от 0,33 до 5~секунд. Измерительная программа должна учитывать этот разброс.

\subsection{Автоматический сброс {\Arduino} и необходимые изменения в программе измерительной установки}

Микроконтроллер {\Arduino} реализован таким образом, что при открытии последовательного порта происходит сброс микроконтроллера. При этом в течении примерно 1~секунды микроконтроллер находится в состоянии ожидания --- это необходимо в целях прошивки микропрограмм. Только после этого, спустя небольшое время, требуемое инициализации микропрограммы, мультиметр готов к работе.

С точки зрения пользователя это проявляется в том, что после открытия последовательного порта мультметр в течении примерно 1~секунды не реагирует на команды. Иногда это может приводить с сбою управляющей программы измерительной установки.

Обеспечить работоспособность можно следующими способами.

\begin{enumerate}

\item Если имеется возможность модифицировать программу измерительной установки, то рекомендуется сразу по открытии последовательного порта выдержать секундную паузу.

\item Если программа позволяет настраивать время таймаута ответа мультиметра, то увеличьте значение таймаута до 2 секунд, чтобы гарантированно <<дождаться>> ответа.

\item Наконец, можно аппаратно модифицировать {\Arduino}, чтобы отключить автоматический сброс при открытии последовательного порта. В этом случае сброс микроконтроллера будет происходить только при потере питания, то есть при отключении от ПК.

См. документацию к {\Arduino}, где рассмотрены способы отключения автоматического сброса.

\end{enumerate}


\section{Система SCPI команд}

В данном разделе приведены все \SCPI{} команды, реализованные в прошивке. Порядок изложения --- алфавитный с разбивкой на подсистемы. Команда может сопровождаться комментарием, описывающим особенности реализации.

Данная прошивка реализует ограниченное множество \SCPI{} команд мультиметра Hewlett-Packard (ныне~--- Agilent) \mbox{34401A}. Микроконтроллер подключается к ПЭВМ посредством USB соединения и эмулирует последовательный порт. Таким образом, связка <<микроконтроллер --- вольтметр>> со стороны ПЭВМ выглядит как мультиметр \mbox{34401A}, и может использоваться в измерительных программах без модификации программного кода, хотя и с учётом ограничений \V (по скорости работы, точности и пр.).

Команды, отсутствующие в данном списке, не реализованы. При получении нереализованной или неизвестной команды генерируется ошибка \CMD{-113} <<Undefined header>>.

\subsection{Все команды}

Ниже приведён список  всех реализованных в прошивке SCPI команд. Описание команд и их параметров выходит за рамки данного документа. Предлагаем ознакомиться, например, с документацией к мультиметру Agilent 34401A, где программирование на языке SCPI рассмотрено подробно.

Некоторые команды имеют особенности реализации, которые рассмотрены в последующем разделе.

\begin{verbatim}
*CLS
*ESE <enable value>
*ESE?
*ESR?
*OPC
*OPC?
*PSC {0|1}
*PSC?
*SRE <enable value>
*SRE?
*STB?
*RST
*TST?
*IDN?

INITiate
FETCh?
READ?

CONFigure
  :VOLTage[:DC] {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :VOLTage:DC:RATio {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :VOLTage:AC {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :VOLTage:AC:RATio {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :FRESistance {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
CONFigure?

DATA:POINts?

DISPlay {OFF|ON }
DISPlay?
DISPlay
  :TEXT <quoted string>
  :TEXT?
  :TEXT:CLEar

INPut
  :IMPedance:AUTO {OFF|ON}
  :IMPedance:AUTO?
  
MEASure
  :VOLTage[:DC]? {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :VOLTage:DC:RATio? {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :VOLTage:AC? {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :VOLTage:AC:RATio? {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}
  :FRESistance? {<range>|MIN|MAX|DEF|AUTO},{<resolution>|MIN|MAX|DEF}

ROUTe:TERMinals?

SAMPle
  :COUNt {<value>|MINimum|MAXimum}
  :COUNt? [MINimum|MAXimum]

[SENSe:]
  FUNCtion "VOLTage[:DC]"
  FUNCtion "VOLTage[:DC]:RATio"
  FUNCtion "VOLTage:AC"
  FUNCtion "VOLTage:AC:RATio"
  FUNCtion "FRESistance"
  FUNCtion?
[SENSe:]
  VOLTage[:DC]:RANGe {<range>|MINimum|MAXimum}
  VOLTage[:DC]:RANGe? [MINimum|MAXimum]
  VOLTage:AC:RANGe {<range>|MINimum|MAXimum}
  VOLTage:AC:RANGe? [MINimum|MAXimum]
  FRESistance:RANGe {<range>|MINimum|MAXimum}
  FRESistance:RANGe? [MINimum|MAXimum]
[SENSe:]
  VOLTage[:DC]:RANGe:AUTO {OFF|ON }
  VOLTage[:DC]:RANGe:AUTO?
  VOLTage:AC:RANGe:AUTO {OFF|ON }
  VOLTage:AC:RANGe:AUTO?
  FRESistance:RANGe:AUTO {OFF|ON }
  FRESistance:RANGe:AUTO?
[SENSe:]
  VOLTage[:DC]:RESolution {<resolution>|MINimum|MAXimum}
  VOLTage[:DC]:RESolution? [MINimum|MAXimum]
  VOLTage:AC:RESolution {<resolution>|MINimum|MAXimum}
  VOLTage:AC:RESolution? [MINimum|MAXimum]
  FRESistance:RESolution {<resolution>|MINimum|MAXimum}
  FRESistance:RESolution? [MINimum|MAXimum]
[SENSe:]
  VOLTage[:DC]:NPLCycles {100|MINimum|MAXimum}
  VOLTage[:DC]:NPLCycles? [MINimum|MAXimum]
  FRESistance:NPLCycles {100|MINimum|MAXimum}
  FRESistance:NPLCycles? [MINimum|MAXimum]
[SENSe:]
  ZERO:AUTO {OFF|ONCE|ON}
  ZERO:AUTO?
  
STATus
  :QUEStionable:ENABle <enable value>
  :QUEStionable:ENABle?
  :QUEStionable:EVENt?
STATus:PRESet

SYSTem
  :BEEPer
  :BEEPer:STATe {OFF|ON}
  :BEEPer:STATe?
SYSTem:ERRor?
SYSTem:VERSion?
SYSTem:LOCal
SYSTem:REMote
SYSTem:RWLock

TRIGger
  :SOURce {BUS|IMMediate |EXTernal}
  :SOURce?
TRIGger
  :DELay {<seconds>|MINimum|MAXimum}
  :DELay? [MINimum|MAXimum]
TRIGger
  :DELay:AUTO {OFF|ON}
  :DELay:AUTO?
TRIGger
  :COUNt {<value>|MINimum|MAXimum|INFinite}
  :COUNt? [MINimum|MAXimum]
\end{verbatim}

\subsection{Особенности реализации}

Некоторые реализованные SCPI команды имеют поведение, несколько отличающееся от стандартного, что вызвано ограниченными возможностями \V{}. Ниже приведены все такие команды и приведены особенности их реализации.

Команды, не вошедшие в данный раздел, не имеют каких-либо значимых особенностей реализации.

\SUBSYSTEMSECTION{IEEE-488}

\CMDSECTION{*IDN?}

Возвращается строка \RESPONSE{V7-28,{\it version},{\it date}} где \RESPONSE{{\it version}}~--- версия прошивки, \RESPONSE{{\it date}}~--- дата сборки.

\CMDSECTION{*TST?}

Прошивка производит тестирование путём последовательного переключения режимов измерения (постоянное напряжение, отношение напряжений и т.~д.) с проверкой того, что требуемый режим действительно установлен.

\SUBSYSTEMSECTION{CONFigure}

В командах \CMD{CONFigure:<function>} параметр \PARAM{resolution} не используется, поскольку \V{} не имеет возможности управления точностью измерений. См. раздел, посвящённый точности измерений, на стр.~\pageref{sec_precision}.

\SUBSYSTEMSECTION{DISPlay}

\V{} не имеет дисплея, на котором возможно было бы отображать произвольный текст. Поэтому все реализованные команды из данной секции отрабатывают без ошибок, но фактически заданный текст нигде не отображается.

\SUBSYSTEMSECTION{INPut}

\CMDSECTION{INPut:IMPedance:AUTO}

\V{} не имеет возможности управления входным сопротивлением, поэтому данная команда отрабатывает без ошибок, аргумент команды проверяется на допустимость значения, но далее его значение игнорируется.

\CMDSECTION{INPut:IMPedance:AUTO?}

Всегда возвращается \RESPONSE{1}.

\SUBSYSTEMSECTION{MEASure}

В командах \CMD{MEASure:<function>} параметр \PARAM{resolution} не используется, поскольку \V{} не имеет возможности управления точностью измерений. См. раздел, посвящённый точности измерений, на стр.~\pageref{sec_precision}.

\SUBSYSTEMSECTION{ROUTe}

\CMDSECTION{ROUTe:TERMinals?}

Всегда возвращает \RESPONSE{FRON}.

\SUBSYSTEMSECTION{SENSe}

В командах \CMD{SENSe:<function>:RESolution} параметр \PARAM{resolution} не используется, поскольку \V{} не имеет возможности управления точностью измерений. Аналогично игнорируется параметр \PARAM{nplc} в командах \CMD{SENSe:<function>:NPLCycles}. Команды \CMD{SENSe:<function>:RESolution?} всегда возвращают значение, равное текущему диапазону, умноженному на $10^{-5}$. Команды \CMD{SENSe:<function>:NPLCycles?} всегда возвращают \RESPONSE{100}.

См. раздел, посвящённый точности измерений, на стр.~\pageref{sec_precision}.

\CMDSECTION{ZERO:AUTO}

\V{} не имеет возможности управления автоподстройкой ноля, поэтому данная команда отрабатывает без ошибок, аргумент команды проверяется на допустимость значения, но далее его значение игнорируется.

\CMDSECTION{ZERO:AUTO?}

Всегда возвращается \RESPONSE{1}.

\SUBSYSTEMSECTION{SYSTem}

\CMDSECTION{SYSTem:BEEPer}

Наличие звука зависит от того, подключён ли звукоизлучатель к \Arduino{}. См. раздел <<Зуммер>> на стр.~\pageref{sec_zummer}.

\CMDSECTION{SYSTem:LOCal}

После перевода \V{} в локальный режим, управление вольтметром при помощи SCPI команд невозможно.

\CMDSECTION{SYSTem:REMote}

Команда \CMD{SYSTem:REMote} всегда действует аналогично команде \CMD{SYSTem:RWLock}, то есть управление вольтметром с передней панели запрещено в remote-режиме.

\subsection{Ошибки реализации}

В данном разделе приведены известные авторам ошибки в логике работы адаптера.

\subsubsection{Несколько команд-запросов в одном пакете}

Согласно спецификации SCPI пользователь может передать 2 и более команд-запросов (содержащих в имени \CMD{?}) в одном пакете, разделённых точкой с запятой. Ответы на команды должны возвращаться в одной строке также разделённые точкой с запятой. Например, команда \CMD{*OPC?;*OPC?}
должна вернуть \RESPONSE{1;1}.

В текущуй версии прошивки допускается передавать несколько команд в одном пакете, но ответы будут возвращаться в разных строках, то есть ответом на \CMD{*OPC?;*OPC?} будет:

\begin{verbatim}
1
1
\end{verbatim}

Рекомендуется не передавать несколько-команд запросов в одном пакете. При этом управляющие команды, могут передаваться без ограничений, например: 

\begin{verbatim}
*RST;CONF:VOLT;INIT;*OPC?
\end{verbatim}

В данном пакете только одна команда --- \CMD{*OPC?} --- возвращает результат, поэтому поведение вольтметра будет в соответствии со спецификацией SCPI.

\section{Подключение {\Arduino} к \V}

\subsection{Распайка разъёмов}

Управление и считывание данных с {\V} осуществляется по двум разъёмам на задней панели вольтметра: ЦПУ и ДУ.

Распайка разъёмов ЦПУ и ДУ представлена в таблицах~\ref{tab_cpu_wires} (стр.~\pageref{tab_cpu_wires}) и~\ref{tab_rc_wires} (стр.~\pageref{tab_rc_wires}).

Расположение контактов на разъёмах ЦПУ и ДУ изображено на рисунках~\ref{pic-cpu-jack} (стр.~\pageref{pic-cpu-jack}) и~\ref{pic-rc-jack} (стр.~\pageref{pic-rc-jack}).

\begin{table*}
\begin{center}
\caption{Распайка разъёма ЦПУ (56 контактов)}
\begin{tabular}{cccc}
\hline \hline
Контакт & Контакт & Контакт & Контакт \\
Arduino & разъёма ЦПУ & Arduino & разъёма ЦПУ \\
\hline
GND & 1 & - & А \\
- & 2 & - & Б \\
- & 3 & - & В \\
- & 4 & - & Г \\
+5V & 5 & 19 & Д \\
2 & 6 & 22 & Е \\
23 & 7 & 24 & Ж \\
- & 8 & - & <<З>> \\
- & 9 & - & И \\
- & 10 & 25 & К \\
26 & 11 & 27 & Л \\
28 & 12 & - & М \\
20 & 13 & - & Н \\
29 & 14 & 30 & <<О>> \\
31 & 15 & 32 & П \\
A0 & 16 & 3 & Р \\
A1 & 17 & A2 & С \\
A3 & 18 & 33 & Т \\
34 & 19 & 35 & У \\
36 & 20 & 37 & Ф \\
38 & 21 & 39 & Х \\
40 & 22 & 41 & Ц \\
42 & 23 & 43 & Ч \\
44 & 24 & 45 & Ш \\
46 & 25 & 47 & Ы \\
48 & 26 & 49 & Э \\
50 & 27 & 51 & Ю \\
52 & 28 & 53 & Я \\
\hline \hline
\end{tabular}
\label{tab_cpu_wires}
\end{center}
\end{table*}

\begin{figure*}
\begin{center}
\includegraphics[width=\textwidth, clip, viewport=0 800 360 830]{cpu-jack}
\end{center}
\caption{Расположение контактов на разъёме ЦПУ}
\label{pic-cpu-jack}
\end{figure*}

\begin{table*}
\begin{center}
\caption{Распайка разъёма ДУ (22 контакта)}
\begin{tabular}{cccc}
\hline \hline
Контакт & Контакт & Контакт & Контакт \\
Arduino & разъёма ДУ & Arduino & разъёма ДУ \\
\hline
GND & 1 & 4 & А \\
5 & 2 & 6 & Б \\
7 & 3 & 8 & В \\
14 & 4 & 21 & Г \\
9 & 5 & 10 & Д \\
11 & 6 & 12 & Е \\
15 & 7 & 16 & Ж \\
17 & 8 & - & <<З>> \\
- & 9 & - & И \\
- & 10 & - & К \\
- & 11 & - & Л \\
\hline \hline
\end{tabular}
\label{tab_rc_wires}
\end{center}
\end{table*}

\begin{figure*}
\begin{center}
\includegraphics[width=\textwidth, clip, viewport=0 800 360 830]{rc-jack}
\end{center}
\caption{Расположение контактов на разъёме ДУ}
\label{pic-rc-jack}
\end{figure*}

\end{document}
